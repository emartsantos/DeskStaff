import{w as ee,v as ie,z as ae,a as p,p as e}from"./chunk-EPOLDU6W-lxn-7cHT.js";import{L as C,a as y,C as se,s as I}from"./supabase-D95lysMu.js";import{c as D,C as te,B as l}from"./card-D0Zu7Dju.js";import{M as _,E as P,R as T,T as O}from"./triangle-alert-DaEtPd0U.js";const re=[["path",{d:"m10 17 5-5-5-5",key:"1bsop3"}],["path",{d:"M15 12H3",key:"6jk70r"}],["path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",key:"u53s6r"}]],H=D("log-in",re);const ne=[["path",{d:"M22 13V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12c0 1.1.9 2 2 2h8",key:"12jkf8"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}],["path",{d:"m16 19 2 2 4-4",key:"1b14m6"}]],le=D("mail-check",ne);const ce=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}]],q=D("shield",ce),he=ee(function(){const n=ie(),S=ae(),[g,s]=p.useState("loading"),[N,t]=p.useState(""),[d,W]=p.useState(""),[z,X]=p.useState(null),[de,L]=p.useState(0),[F,x]=p.useState(3),$=3,J=()=>typeof window<"u"&&localStorage.getItem("pending_email")||"",K=()=>typeof window<"u"&&localStorage.getItem("pending_user_id")||null,u=()=>{typeof window<"u"&&(localStorage.removeItem("pending_email"),localStorage.removeItem("pending_user_id"))},k=async(a,o)=>{try{const{data:i,error:h}=await I.from("users").select("email_verified, id, email, first_name, last_name").eq("email",a.toLowerCase()).maybeSingle();if(h)return console.error("Error checking user verification:",h),{verified:!1,error:h.message};if(!i)return{verified:!1,error:"User not found in database"};const m=i.email_verified===!0,{data:{session:r},error:c}=await I.auth.getSession();if(c)return console.error("Session check error:",c),{verified:m,userId:i.id,userData:i,dbVerified:m,authVerified:!1};const b=r?.user?.email_confirmed_at!==null||r?.user?.confirmed_at!==null;return{verified:m&&b,userId:i.id,userData:i,dbVerified:m,authVerified:b}}catch(i){return console.error("Exception checking verification status:",i),{verified:!1,error:"Failed to check verification status"}}},w=async(a,o)=>{try{const{error:i}=await I.from("users").update({email_verified:o,updated_at:new Date().toISOString()}).eq("email",a.toLowerCase());return i?(console.error("Error updating user verification in DB:",i),!1):!0}catch(i){return console.error("Exception updating verification in DB:",i),!1}},Q=async a=>{try{const{verified:o,dbVerified:i,authVerified:h,userData:m}=await k(a);if(o){s("already_verified"),t(`Welcome back ${m?.first_name||""}! Your email is already verified. Redirecting to login...`),u();const r=setInterval(()=>{x(c=>c<=1?(clearInterval(r),n("/login",{state:{message:"Email already verified! You can now log in.",email:a}}),0):c-1)},1e3);return!0}return!1}catch(o){return console.error("Error checking if already verified:",o),!1}},M=async(a,o)=>{if(o>=$){s("unverified"),t(`Email verification is taking longer than expected. Please check your email at ${a} and click the verification link. You may need to manually refresh this page after verifying.`);return}await new Promise(r=>setTimeout(r,3e3));const{verified:i,dbVerified:h,authVerified:m}=await k(a);if(i){h||await w(a,!0),s("success"),t("Email verified successfully! Your account is now active."),u();const r=setInterval(()=>{x(c=>c<=1?(clearInterval(r),n("/login",{state:{message:"Email verified successfully! You can now log in.",email:a}}),0):c-1)},1e3)}else if(m&&!h){await w(a,!0),s("success"),t("Email verified successfully! Database updated."),u();const r=setInterval(()=>{x(c=>c<=1?(clearInterval(r),n("/login",{state:{message:"Email verified successfully! You can now log in.",email:a}}),0):c-1)},1e3)}else L(o+1),s("checking_verification"),t(`Still checking verification status... (Attempt ${o+1}/${$})`),setTimeout(()=>{M(a,o+1)},3e3)};p.useEffect(()=>{const a=async()=>{try{const i=S.state?.email||J(),h=S.state?.userId||K();if(W(i),X(h),await Q(i))return;const r=window.location.hash;if(r.includes("type=signup")||r.includes("token=")){s("checking_verification"),t("Verifying your email... Please wait.");const{error:c}=await I.auth.getSession();if(c){console.error("Session error after email verification:",c),s("error"),t("Email verification failed. Please try again.");return}const{verified:b,dbVerified:E,authVerified:v,error:f}=await k(i);if(f&&f!=="User not found in database"&&console.error("Verification check error:",f),b){E||await w(i,!0),s("success"),t("Email verified successfully! Your account is now active."),u();const V=setInterval(()=>{x(j=>j<=1?(clearInterval(V),n("/login",{state:{message:"Email verified successfully! You can now log in.",email:i}}),0):j-1)},1e3)}else if(v&&!E){await w(i,!0),s("success"),t("Email verified successfully! Database updated."),u();const V=setInterval(()=>{x(j=>j<=1?(clearInterval(V),n("/login",{state:{message:"Email verified successfully! You can now log in.",email:i}}),0):j-1)},1e3)}else s("checking_verification"),t("Email verification in progress... Checking status."),L(0),setTimeout(()=>{M(i,0)},3e3)}else{const{verified:c,dbVerified:b,authVerified:E}=await k(i);if(c){s("success"),t("Your email is already verified! You can now log in."),u();const v=setInterval(()=>{x(f=>f<=1?(clearInterval(v),n("/login",{state:{message:"Email already verified! You can now log in.",email:i}}),0):f-1)},1e3)}else if(E&&!b){await w(i,!0),s("success"),t("Email verification completed! Database updated."),u();const v=setInterval(()=>{x(f=>f<=1?(clearInterval(v),n("/login",{state:{message:"Email verified successfully! You can now log in.",email:i}}),0):f-1)},1e3)}else{s("pending"),t(`Registration completed! We've sent a verification email to ${i}. Please check your inbox and click the link to activate your account.`);const v=setInterval(async()=>{const{verified:f,dbVerified:V,authVerified:j}=await k(i);if(f||j&&!V){clearInterval(v),j&&!V&&await w(i,!0),s("success"),t("Email verified! Your account is now active."),u();const Z=setInterval(()=>{x(U=>U<=1?(clearInterval(Z),n("/login",{state:{message:"Email verified successfully! You can now log in.",email:i}}),0):U-1)},1e3)}},5e3);setTimeout(()=>{clearInterval(v),g==="pending"&&(s("unverified"),t(`Verification is taking longer than expected. Please check your email at ${i} and click the verification link.`))},3e5)}}}catch(i){console.error("Auth callback error:",i),s("error"),t("Something went wrong. Please try registering again.")}},o=setTimeout(()=>{a()},1e3);return()=>clearTimeout(o)},[n,S]);const A=async()=>{try{if(!d)return;s("loading"),t("Sending verification email...");const{error:a}=await I.auth.resend({type:"signup",email:d,options:{emailRedirectTo:`${window.location.origin}/verification`}});if(a)throw a;s("pending"),t(`âœ… Verification email resent to ${d}. Please check your inbox.`)}catch(a){console.error("Error resending verification:",a),s("error"),t("âŒ Failed to resend verification email. Please try again.")}},Y=async()=>{try{s("checking_verification"),t("Checking verification status...");const{verified:a,dbVerified:o,authVerified:i,userData:h}=await k(d);if(a){s("success"),t("âœ… Email verified! Your account is now active."),u();const m=setInterval(()=>{x(r=>r<=1?(clearInterval(m),n("/login",{state:{message:"Email verified successfully! You can now log in.",email:d}}),0):r-1)},1e3)}else if(i&&!o){await w(d,!0),s("success"),t("âœ… Email verification completed! Database updated."),u();const m=setInterval(()=>{x(r=>r<=1?(clearInterval(m),n("/login",{state:{message:"Email verified successfully! You can now log in.",email:d}}),0):r-1)},1e3)}else s("unverified"),t(`âŒ Email not verified yet. Please check your email at ${d} and click the verification link.`)}catch(a){console.error("Error checking verification:",a),s("error"),t("Failed to check verification status.")}},G=()=>{n("/verification",{state:{email:d,userId:z}})},B=()=>{u(),n("/login",{state:{message:"Redirecting to login...",email:d}})},R=()=>{if(d){const a=`mailto:${d}`;window.open(a,"_blank")}};return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800 px-4",children:e.jsx(te,{className:"w-full max-w-md p-8 shadow-xl",children:e.jsxs("div",{className:"flex flex-col items-center justify-center space-y-6 text-center",children:[g==="loading"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"h-20 w-20 rounded-full border-4 border-primary/20"}),e.jsx(C,{className:"h-20 w-20 absolute inset-0 m-auto animate-spin text-primary"})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold dark:text-white",children:"Processing..."}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"Completing your registration. Please wait."})]})]}),g==="already_verified"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-20 w-20 rounded-full bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center",children:e.jsx(y,{className:"h-10 w-10 text-emerald-600 dark:text-emerald-400"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold dark:text-white",children:"Already Verified! âœ…"}),e.jsx("p",{className:"text-muted-foreground mt-4",children:N}),e.jsxs("div",{className:"mt-6 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm",children:[e.jsx(y,{className:"h-4 w-4 text-emerald-500"}),e.jsx("span",{className:"text-emerald-600 dark:text-emerald-400",children:"Email already verified"})]}),e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm",children:[e.jsx(y,{className:"h-4 w-4 text-emerald-500"}),e.jsx("span",{className:"text-emerald-600 dark:text-emerald-400",children:"Account is active"})]}),e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm",children:[e.jsx(C,{className:"h-4 w-4 animate-spin text-blue-500"}),e.jsxs("span",{className:"text-blue-600 dark:text-blue-400",children:["Redirecting to login in ",F," seconds..."]})]})]})]}),e.jsxs("div",{className:"space-y-4 w-full",children:[e.jsxs(l,{onClick:B,className:"w-full",variant:"default",children:[e.jsx(H,{className:"h-4 w-4 mr-2"}),"Go to Login Now"]}),e.jsx(l,{onClick:()=>n("/"),variant:"outline",className:"w-full",children:"Go to Homepage"})]})]}),g==="checking_verification"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"h-20 w-20 rounded-full border-4 border-primary/20"}),e.jsx(C,{className:"h-20 w-20 absolute inset-0 m-auto animate-spin text-primary"})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold dark:text-white",children:"Checking Verification"}),e.jsx("p",{className:"text-muted-foreground mt-4",children:N}),e.jsxs("div",{className:"mt-4 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm",children:[e.jsx(C,{className:"h-4 w-4 animate-spin text-blue-500"}),e.jsx("span",{className:"text-blue-600 dark:text-blue-400",children:"Verifying email confirmation..."})]}),e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm",children:[e.jsx(q,{className:"h-4 w-4 text-amber-500"}),e.jsx("span",{className:"text-amber-600 dark:text-amber-400",children:"Checking database status..."})]})]})]})]}),g==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-20 w-20 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center",children:e.jsx(_,{className:"h-10 w-10 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold dark:text-white",children:"Check Your Email! ðŸ“§"}),e.jsx("p",{className:"text-muted-foreground mt-4",children:N}),e.jsxs("div",{className:"mt-6 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm",children:[e.jsx(y,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"text-green-600 dark:text-green-400",children:"Account created successfully"})]}),e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm",children:[e.jsx(_,{className:"h-4 w-4 text-blue-500"}),e.jsxs("span",{className:"text-blue-600 dark:text-blue-400",children:["Verification email sent to ",d]})]}),e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm",children:[e.jsx(C,{className:"h-4 w-4 animate-spin text-amber-500"}),e.jsx("span",{className:"text-amber-600 dark:text-amber-400",children:"Waiting for email verification"})]})]})]}),e.jsxs("div",{className:"space-y-4 w-full",children:[e.jsxs(l,{onClick:R,variant:"default",className:"w-full",children:[e.jsx(P,{className:"h-4 w-4 mr-2"}),"Open Email App"]}),e.jsxs(l,{onClick:Y,variant:"outline",className:"w-full",children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),"Check Verification Status"]}),e.jsxs(l,{onClick:A,variant:"secondary",className:"w-full",children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Resend Verification Email"]}),e.jsx(l,{onClick:G,className:"w-full",children:"Go to Verification Page"})]})]}),g==="unverified"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-20 w-20 rounded-full bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center",children:e.jsx(O,{className:"h-10 w-10 text-amber-600 dark:text-amber-400"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold dark:text-white",children:"Verification Required"}),e.jsx("p",{className:"text-muted-foreground mt-4",children:N}),e.jsxs("div",{className:"mt-6 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm",children:[e.jsx(O,{className:"h-4 w-4 text-amber-500"}),e.jsx("span",{className:"text-amber-600 dark:text-amber-400",children:"Email not verified yet"})]}),e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm",children:[e.jsx(q,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"text-red-600 dark:text-red-400",children:"Cannot log in until email is verified"})]})]})]}),e.jsxs("div",{className:"space-y-4 w-full",children:[e.jsxs(l,{onClick:R,variant:"default",className:"w-full",children:[e.jsx(P,{className:"h-4 w-4 mr-2"}),"Open Email App"]}),e.jsxs(l,{onClick:Y,variant:"outline",className:"w-full",children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),"Check Verification Status"]}),e.jsxs(l,{onClick:A,className:"w-full",children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Resend Verification Email"]}),e.jsx(l,{onClick:G,variant:"secondary",className:"w-full",children:"Go to Verification Page"})]})]}),g==="success"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-20 w-20 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center",children:e.jsx(le,{className:"h-10 w-10 text-green-600 dark:text-green-400"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold dark:text-white",children:"Email Verified! âœ…"}),e.jsx("p",{className:"text-muted-foreground mt-2",children:N}),e.jsxs("div",{className:"mt-6 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm",children:[e.jsx(y,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"text-green-600 dark:text-green-400",children:"Account activated successfully"})]}),e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm",children:[e.jsx(y,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"text-green-600 dark:text-green-400",children:"Database updated"})]}),e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm",children:[e.jsx(y,{className:"h-4 w-4 text-green-500"}),e.jsx("span",{className:"text-green-600 dark:text-green-400",children:"You can now log in"})]}),e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm",children:[e.jsx(C,{className:"h-4 w-4 animate-spin text-blue-500"}),e.jsxs("span",{className:"text-blue-600 dark:text-blue-400",children:["Redirecting to login in ",F," seconds..."]})]})]})]}),e.jsxs("div",{className:"space-y-4 w-full",children:[e.jsxs(l,{onClick:B,className:"w-full",variant:"default",children:[e.jsx(H,{className:"h-4 w-4 mr-2"}),"Go to Login Now"]}),e.jsx(l,{onClick:()=>n("/"),variant:"outline",className:"w-full",children:"Go to Homepage"})]})]}),g==="error"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-20 w-20 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center",children:e.jsx(se,{className:"h-10 w-10 text-red-600 dark:text-red-400"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold dark:text-white",children:"Oops! Something went wrong"}),e.jsx("p",{className:"text-muted-foreground mt-2",children:N})]}),e.jsxs("div",{className:"flex flex-col gap-3 w-full",children:[e.jsxs(l,{onClick:Y,variant:"outline",children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),"Check Status Again"]}),e.jsxs(l,{variant:"secondary",onClick:A,children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Resend Verification Email"]}),d&&e.jsxs(l,{onClick:R,variant:"default",children:[e.jsx(P,{className:"h-4 w-4 mr-2"}),"Open Email App"]}),e.jsx(l,{variant:"outline",onClick:()=>n("/register"),children:"Try Registration Again"}),e.jsx(l,{onClick:()=>n("/"),children:"Go Home"})]})]})]})})})});export{he as default};
